# only redirect module from stderr to stdout in interactive mode
# to avoid breaking non interactive session (scp, sftp, etc)
case "$-" in
   *i*)
      moduleraw() { eval `@TCLSH@ @libexecdir@/modulecmd.tcl sh $*`; }
      module() { moduleraw $* 2>&1 ; }
      # if sh is bash, export functions to get them defined in sub-shells
      if [ "${BASH:-}" != '' ]; then
         export -f moduleraw
         export -f module
      fi
      ;;
   *)
      module() { eval `@TCLSH@ @libexecdir@/modulecmd.tcl sh $*`; }
      if [ "${BASH:-}" != '' ]; then
         export -f module
      fi
esac

@setswitchml@# define function to switch between C and Tcl versions of Modules
@setswitchml@switchml() {
@setswitchml@   # determine currently used module version
@setswitchml@   currel=`module --version 2>&1 | grep -E '^(Modules|VERSION=)'`
@setswitchml@   case $currel in
@setswitchml@      *Tcl*)
@setswitchml@         mlver='Tcl'
@setswitchml@         curpath='@swmlbindir@'
@setswitchml@         curmanpath='@swmlmandir@'
@setswitchml@         ;;
@setswitchml@      *VERSION*)
@setswitchml@         mlver='C'
@setswitchml@         curpath='@cverbindir@'
@setswitchml@         curmanpath='@cvermandir@'
@setswitchml@         ;;
@setswitchml@   esac
@setswitchml@
@setswitchml@   # remove specific paths set by current module version
@setswitchml@   if [ -n "$PATH" -a "${curpath:-}" != '' ]; then
@setswitchml@      PATH=`echo $PATH | sed -e "s|:${curpath}||" -e "s|${curpath}:||"`
@setswitchml@   fi
@setswitchml@   if [ -n "$MANPATH" -a "${curmanpath:-}" != '' ]; then
@setswitchml@      MANPATH=`echo $MANPATH | sed -e "s|:${curmanpath}||" -e "s|${curmanpath}:||"`
@setswitchml@   fi
@setswitchml@
@setswitchml@   # switch module version
@setswitchml@   if [ "$mlver" = 'Tcl' ]; then
@setswitchml@      if [ -d @cverinitdir@ ]; then
@setswitchml@         echo 'Switching to Modules C version'
@setswitchml@         . @cverinitdir@/sh
@setswitchml@      else
@setswitchml@         echo 'Cannot find Modules C version'
@setswitchml@         return 1
@setswitchml@      fi
@setswitchml@   else
@setswitchml@      echo 'Switching to Modules Tcl version'
@setswitchml@      . @initdir@/sh
@setswitchml@   fi
@setswitchml@}
@setswitchml@if [ "${BASH:-}" != '' ]; then
@setswitchml@   export -f switchml
@setswitchml@fi
@setswitchml@
# setup ENV variables to get module defined in sub-shells (works for 'sh'
# and 'ksh' in interactive mode and 'sh' (zsh-compat), 'bash' and 'ksh'
# (zsh-compat) in non-interactive mode.
ENV=@initdir@/profile.sh; export ENV
BASH_ENV=@initdir@/bash; export BASH_ENV

MODULESHOME=@prefix@; export MODULESHOME

@setbinpath@case ":$PATH:" in
@setbinpath@   *:@bindir@:*) ;;
@setbinpath@   *) PATH=@bindir@${PATH:+:}$PATH; export PATH
@setbinpath@esac
@setbinpath@
@setmanpath@manpath=`manpath 2>/dev/null`
@setmanpath@case ":$manpath:" in
@setmanpath@   *:@mandir@:*) ;;
@setmanpath@   *) MANPATH=@mandir@${manpath:+:}$manpath; export MANPATH
@setmanpath@esac
@setmanpath@
if [ "${MODULEPATH:-}" = '' ]; then
   if [ -r @initdir@/.modulespath ]; then
      MODULEPATH=`sed -n 's/[ 	#].*$//; /./H; $ { x; s/^\n//; s/\n/:/g; p; }' \
         @initdir@/.modulespath`; export MODULEPATH
   else
      MODULEPATH=; export MODULEPATH
   fi
fi

if [ "${LOADEDMODULES:-}" = '' ]; then
   LOADEDMODULES=; export LOADEDMODULES
fi

# load modulerc only if module environment is empty
if [ -r @initdir@/modulerc -a "$MODULEPATH" = '' -a "$LOADEDMODULES" = '' ]; then
   . @initdir@/modulerc
fi
